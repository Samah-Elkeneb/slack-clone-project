<turbo-frame id="messages_frame">
  <div id="channel-messages" data-room="<%= channel.name %>_<%= channel.id %>" data-controller="modal" data-modal-target="frame" class="h-[calc(100vh-3rem)] flex flex-col min-h-0">
    <header class="px-6 py-3 border-b border-slate-200 bg-white/60 backdrop-blur-sm flex-none">
      <div class="flex items-center gap-2">
        <svg viewBox="0 0 20 20" class="w-6 h-10" id="<%= dom_id(channel, :channel_icon) %>">
          <% if channel.public %>
            <path fill="black" fill-rule="evenodd" d="M9.74 3.878a.75.75 0 1 0-1.48-.255L7.68 7H3.75a.75.75 0 0 0 0 1.5h3.67L6.472 14H2.75a.75.75 0 0 0 0 1.5h3.463l-.452 2.623a.75.75 0 0 0 1.478.255l.496-2.878h3.228l-.452 2.623a.75.75 0 0 0 1.478.255l.496-2.878h3.765a.75.75 0 0 0 0-1.5h-3.506l.948-5.5h3.558a.75.75 0 0 0 0-1.5h-3.3l.54-3.122a.75.75 0 0 0-1.48-.255L12.43 7H9.2zM11.221 14l.948-5.5H8.942L7.994 14z" clip-rule="evenodd"></path>
          <% else %>
            <path fill="black" fill-rule="evenodd" d="M10 1.5A4.5 4.5 0 0 0 5.5 6v1.5h-.25A2.25 2.25 0 0 0 3 9.75v6.5c0 .966.784 1.75 1.75 1.75h10.5A1.75 1.75 0 0 0 17 16.25v-6.5a2.25 2.25 0 0 0-2.25-2.25h-.25V6A4.5 4.5 0 0 0 10 1.5m3 6V6a3 3 0 1 0-6 0v1.5zM4.5 9.75A.75.75 0 0 1 5.25 9h9.5a.75.75 0 0 1 .75.75v6.5a.25.25 0 0 1-.25.25H4.75a.25.25 0 0 1-.25-.25z" clip-rule="evenodd"></path>
          <% end %>
        </svg>
        <h2 class="text-lg font-semibold" id="<%= dom_id(channel, :header) %>">
          <a href="<%= channel_path(channel) %>" data-action="click->modal#open">
            <%= channel.name %>
          </a>
        </h2>
      </div>
      <p class="text-xs text-slate-500 ml-8">channel description</p>
    </header>
    <div class="flex-1 min-h-0 overflow-y-auto bg-gray-100 p-4" id="chat-box" data-controller="infinite" data-infinite-target="box" data-load-more-url="<%= load_more_channel_path(channel)%>">
      <% if messages.empty? %>
        <div id="no-messages-div" class="text-center text-slate-500 py-12"> no messages yet </div>
      <% else %> <% messages.each do |msg| %>
          <%= render partial: "message_item", locals: { message: msg } %>
        <% end %>
      <% end %>
    </div>
    <%= form_with model: new_message,
         local: true do |f| %>
      <%= f.hidden_field :channel_id, value: channel.id %>
      <%= f.hidden_field :user_id, value: current_user.id %>
      <div class="flex-none border border-gray-300 rounded-lg p-1 flex flex-col m-2">
        <%= f.rich_text_area :content, id: "message_content", class: "trix-editor p-2 border rounded-lg w-full" %>
        <div class="flex justify-end mt-2">
          <button type="submit"
            id="send_button",
            disabled="disabled",
            class="p-2 bg-gray-400 rounded-full transition-all duration-200 cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg"
           class="h-6 w-6 text-white transform rotate-180 transition-colors duration-200"
           fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2 12l19-7-10 7 10 7-19-7z"/>
            </svg>
          </button>
        </div>
      </div>
    <% end %>
  </div>
</turbo_frame>
<script>
  document.addEventListener("trix-change", () => {
    const editor = document.querySelector("#message_content");
    const button = document.querySelector("#send_button");
    if (editor && button) {
      editor.addEventListener("trix-change", () => {
        if(editor.value.trim().length > 0){
          button.classList.remove("bg-gray-400");
          button.classList.add("bg-green-700");
          button.classList.remove("cursor-not-allowed");
          button.disabled = false;
        } else {
          button.classList.remove("bg-green-700");
          button.classList.add("bg-gray-400");
          button.classList.add("cursor-not-allowed");
          button.disabled = true;
        }
      });
    }
  });
</script>
