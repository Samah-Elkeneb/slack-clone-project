var ut=Object.defineProperty;var ct=(o,t,e)=>t in o?ut(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var Q=(o,t,e)=>ct(o,typeof t!="symbol"?t+"":t,e);var X=class extends Error{constructor(t){super(t)}};var O=class extends X{name="InternalError"};var k=class{static deviceToUser(t,e,n,r){let s,i;switch(e){case 0:s=t.x,i=r-t.y;break;case 90:s=t.y,i=t.x;break;case 180:s=n-t.x,i=t.y;break;case 270:s=r-t.y,i=n-t.x;break;default:throw new Error(`Unsupported rotation: ${e}`)}return{x:s,y:i}}static userToDevice(t,e,n,r){let s,i;switch(e){case 0:s=t.x,i=r-t.y;break;case 90:s=t.y,i=t.x;break;case 180:s=n-t.x,i=t.y;break;case 270:s=n-t.y,i=r-t.x;break;default:throw new Error(`Unsupported rotation: ${e}`)}return{x:s,y:i}}static deviceRectToUser(t,e,n,r){let{x:s,y:i}=this.deviceToUser({x:t.left,y:t.top},e,n,r),{x:u,y:a}=this.deviceToUser({x:t.right,y:t.bottom},e,n,r);return{left:Math.min(s,u),right:Math.max(s,u),top:Math.max(i,a),bottom:Math.min(i,a)}}static userRectToDevice(t,e,n,r){let{x:s,y:i}=this.userToDevice({x:t.left,y:t.top},e,n,r),{x:u,y:a}=this.userToDevice({x:t.right,y:t.bottom},e,n,r);return{left:Math.min(s,u),right:Math.max(s,u),top:Math.min(i,a),bottom:Math.max(i,a)}}};var Z={SET_BASE_URI:"setBaseURI",OPEN_DOCUMENT:"openDocument",CLOSE_DOCUMENT:"closeDocument",DOWNLOAD_DOCUMENT:"downloadDocument",DRAW_PAGE:"drawPageAsPNG",LOAD_OUTLINE:"loadOutline",LOAD_PAGE_TEXT:"loadPageText",LOAD_PDFINFO:"loadPdfInfo",LOAD_PDF_LAYOUT:"loadPdfLayout",AUTHENTICATE_PASSWORD:"authenticatePassword",GET_PRINT_URL:"getPrintBlobURL",GET_ANNOTATIONS:"getAnnotations",GET_ACROFORM:"getAcroForm",APPLY_ANNOT_CHANGES:"applyAnnotChanges",APPLY_ACROFIELD_CHANGES:"applyAcroFieldChanges",APPLY_REDACTION:"applyRedaction",GET_STAMP_TEMPLATE_IMAGES:"getStampTemplateImages"};var M,K=class{TOAST_ID=1;fetchSub=null;get buffer(){return this.fetchSub!==null?this.fetchSub:(this.fetchSub=this.fetch().then(t=>t),this.fetchSub)}fetch(){return postMessage(["TOAST",this.TOAST_ID,{action:"SHOW",toastOption:{toastStyle:"notification",content:"LOADING_FALLBACK_FONT_DESC",header:"LOADING_FALLBACK_FONT",timeout:null}}]),new Promise(async(t,e)=>{console.debug("Fetching fallback font.");let n=await fetch(`${Y}DroidSansFallback.ttf`);if(!n.ok||n.headers.get("Content-type")!=="font/ttf"){postMessage(["TOAST",this.TOAST_ID,{action:"DISPOSE"}]),e(new Error("Failed to fetch fallback font."));return}let r=new M.Buffer(await n.arrayBuffer());postMessage(["TOAST",this.TOAST_ID,{action:"DISPOSE"}]),t(r)})}},h=class{static isCircle(t){return t.subType==="Circle"}static isSquare(t){return t.subType==="Square"}static isFreeText(t){return t.subType==="FreeText"}static isRedact(t){return t.subType==="Redact"}static isPopup(t){return t.subType==="Popup"}static isStamp(t){return t.subType==="Stamp"}static isHighlight(t){return t.subType==="Highlight"}static isStrikeOut(t){return t.subType==="StrikeOut"}static isUnderline(t){return t.subType==="Underline"}static isTextMarkUp(t){return this.isHighlight(t)||this.isStrikeOut(t)||this.isUnderline(t)}static isText(t){return t.subType==="Text"}static isLine(t){return t.subType==="Line"}static isPolyLine(t){return t.subType==="PolyLine"}static isPolygon(t){return t.subType==="Polygon"}static isInk(t){return t.subType==="Ink"}static isLink(t){return t.subType==="Link"}static isWidget(t){return t.subType==="Widget"}static isColor(t){return Array.isArray(t)&&t.length===3&&t.every(e=>typeof e=="number")}static isQuadPoint(t){return Array.isArray(t)&&t.length===8&&t.every(e=>typeof e=="number")}static isPoint(t){return Array.isArray(t)&&t.length===2&&t.every(e=>typeof e=="number")}static isRect(t){return Array.isArray(t)&&t.length===4&&t.every(e=>typeof e=="number")}};Q(h,"defaultAppearanceFontNameRegex",/\s*([^\s/]+)\s+\d+\s+Tf/);var V=class{openedDocument;constructor(t){this.openedDocument=t}apply(t,e){if(h.isInk(e)){this.applyInk(t,e);return}if(h.isFreeText(e)){this.applyFreeText(t,e);return}if(h.isTextMarkUp(e)){this.applyTextMarkup(t,e);return}if(h.isText(e)){this.applyText(t,e);return}if(h.isLine(e)){this.applyLine(t,e);return}if(h.isRedact(e)){this.applyRedact(t,e);return}if(h.isLink(e)){this.applyLink(t,e);return}if(h.isStamp(e)){this.applyStamp(t,e);return}if(h.isPolyLine(e)){this.applyPolyLine(t,e);return}if(h.isPolygon(e)){this.applyPolygon(t,e);return}if(h.isCircle(e)){this.applyCircle(t,e);return}if(h.isSquare(e)){this.applySquare(t,e);return}if(h.isPopup(e)){this.applyPopup(t,e);return}if(h.isWidget(e)){this.applyWidget(t,e);return}console.warn(`An unsupported annotation has been entered. ${e}`),this.applyCommonField(t,e)}applyInk(t,e){let r=t.getObject().get("InkList").asJS();e.inkList.every(s=>s.every(i=>h.isPoint(i)))&&!Array.isArray(r)&&t.setInkList(e.inkList),this.applyCommonField(t,e),this.applyCommonShape(t,e),t.update(),this.applyRect(t,e)}applyFreeText(t,e){let n=t.getObject(),r=n.get("CL").asJS();Array.isArray(e.CL)&&(!Array.isArray(r)||r.some((i,u)=>i!==e.CL?.[u]))&&n.put("CL",e.CL);let s=n.get("RD").asJS();Array.isArray(e.RD)&&(!Array.isArray(s)||s.some((i,u)=>i!==e.RD?.[u]))&&n.put("RD",e.RD),this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyDefaultAppearance(t,e),this.applyRect(t,e),this.applyLineEndingStyle(t,e),t.update()}applyTextMarkup(t,e){let r=t.getObject().get("QuadPoints").asJS();e.quadPoints.every(s=>h.isQuadPoint(s))&&(!Array.isArray(r)||e.quadPoints.flat().some((s,i)=>s!==r[i]))&&t.setQuadPoints(e.quadPoints),this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyText(t,e){this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyLine(t,e){let n=t.getObject(),r=n.get("L").asJS();e.L.every(u=>h.isPoint(u))&&(!Array.isArray(r)||e.L.flat().some((u,a)=>u!==r[a]))&&t.setLine(e.L[0],e.L[1]);let s=n.get("LL");typeof e.LL=="number"&&(!s.isNumber()||s.asNumber()!==e.LL)&&t.setLineLeader(e.LL);let i=n.get("LLE");typeof e.LLE=="number"&&(!i.isNumber()||i.asNumber()!==e.LLE)&&t.setLineLeaderExtension(e.LLE),this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyLineEndingStyle(t,e),this.applyRect(t,e),this.applyMeasure(t,e),t.update()}applyRedact(t,e){let n=t.getObject(),r=n.get("OverlayText");typeof e.overlayText=="string"&&(!r.isString()||r.asString()!==e.overlayText)&&n.put("OverlayText",e.overlayText);let s=n.get("OC").asJS();h.isColor(e.OC)&&(!Array.isArray(s)||s.some((i,u)=>i!==e.OC?.[u]))&&n.put("OC",e.OC),this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyRect(t,e),this.applyAligment(t,e),t.update()}applyLink(t,e){let n=t.getObject();switch(n.put("BS",{W:0}),e.A.S){case"GoTo":let r=this.openedDocument.loadPage(e.A.D.page).getObject();n.put("A",{S:e.A.S,D:[r,e.A.D.mode]});break;case"URI":n.put("A",{S:e.A.S,URI:`(${e.A.URI})`});break}this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyStamp(t,e){typeof e.name=="string"&&t.setIcon(e.name),this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyPolyLine(t,e){this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyLineEndingStyle(t,e),this.applyRect(t,e),this.applyVertices(t,e),this.applyMeasure(t,e),t.update()}applyPolygon(t,e){this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyRect(t,e),this.applyVertices(t,e),this.applyMeasure(t,e),t.update()}applyCircle(t,e){this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyRect(t,e),t.update()}applySquare(t,e){this.applyCommonField(t,e),this.applyCommonShape(t,e),this.applyRect(t,e),t.update()}applyPopup(t,e){this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyWidget(t,e){this.applyCommonField(t,e),this.applyRect(t,e),t.update()}applyCommonField(t,e){let n=t.getObject(),r=n.get("M");typeof e.M=="string"&&(!r.isString()||r.asString()!==e.M)&&n.put("M",e.M);let s=n.get("C").asJS();h.isColor(e.C)&&(!Array.isArray(s)||s.some((l,y)=>l!==e.C?.[y]))&&t.setColor(e.C);let i=n.get("Contents");typeof e.contents=="string"&&(!i.isString()||i.asString()!==e.contents)&&t.setContents(e.contents);let u=n.get("F");typeof e.F=="number"&&(!u.isNumber()||u.asNumber()!==e.F)&&t.setFlags(e.F);let a=n.get("T");typeof e.T=="string"&&(!a.isString()||a.asString()!==e.T)&&t.setAuthor(e.T);let g=n.get("CA");typeof e.CA=="number"&&(!g.isNumber()||g.asNumber()!==e.CA)&&t.setOpacity(e.CA);let c=n.get("IT");e.IT&&!c.isName()&&n.put("IT",e.IT);let p=n.get("NM");typeof e.NM=="string"&&!p.isString()&&n.put("NM",`(${e.NM})`);let f=n.get("CreationDate");typeof e.CreationDate=="string"&&!f.isString()&&n.put("CreationDate",`(${e.CreationDate})`)}applyCommonShape(t,e){let n=t.getObject(),r=n.get("BS","W");typeof e.BS?.W=="number"&&(!r.isNumber()||r.asNumber()!==e.BS.W)&&t.setBorderWidth(e.BS.W);let s=n.get("BS","S");e.BS?.S&&(!s.isName()||s.asName()!==e.BS.S)&&t.setBorderStyle(e.BS.S);let i=n.get("BS","D").asJS();e.BS?.S==="Dashed"&&Array.isArray(e.BS?.D)&&(!Array.isArray(i)||i.some((c,p)=>c!==e.BS?.D?.[p]))?t.setBorderDashPattern(e.BS.D):e.BS?.S==="Solid"&&Array.isArray(i)&&i.length>0&&t.setBorderDashPattern([]);let u=n.get("IC").asJS();h.isColor(e.IC)&&(!Array.isArray(u)||u.some((c,p)=>c!==e.IC?.[p]))?t.setInteriorColor(e.IC):typeof e.IC>"u"&&Array.isArray(u)&&n.delete("IC");let a=n.get("BE","S");e.BE?.S&&(!a.isName()||a.asName()!==e.BE.S)&&t.setBorderEffect(e.BE.S);let g=n.get("BE","I");typeof e.BE?.I=="number"&&(!g.isNumber()||g.asNumber()!==e.BE.I)&&t.setBorderEffectIntensity(e.BE.I)}applyRect(t,e){let n=t.getObject();h.isRect(e.rect)&&n.put("Rect",e.rect)}applyDefaultAppearance(t,e){if(!e.DA||typeof e.DA.fontName!="string"||typeof e.DA.fontSize!="number"||!h.isColor(e.DA.fontColor))return;let{fontName:n,fontSize:r,fontColor:s}=e.DA,u=t.getObject().get("DA");if(!u.isString()){t.setDefaultAppearance(n,r,s);return}let{color:a,font:g,size:c}=t.getDefaultAppearance(),p=u.asString()?.match(h.defaultAppearanceFontNameRegex)?.[1]??g;a.every((f,l)=>f===s[l])&&p===n&&c===r||t.setDefaultAppearance(n,r,s)}applyLineEndingStyle(t,e){if(!Array.isArray(e.LE))return;let n=t.getObject(),[r="None",s="None"]=e.LE;if(h.isFreeText(e)){n.put("LE",r);return}t.setLineEndingStyles(r,s)}applyVertices(t,e){let n=t.getObject().get("Vertices").asJS(),r=Array.isArray(n)&&e.vertices.flat().every((s,i)=>s===n[i]);!e.vertices.every(s=>h.isPoint(s))||r||t.setVertices(e.vertices)}applyMeasure(t,e){let n=e.Measure;if(!n||n.X?.length===0)return;let r=t.getObject(),s=r.get("Measure").asJS(),i={C:n.X?.[0].C,D:n.X?.[0].D,U:`(${n.X?.[0].U})`,F:"D",SS:"()",RT:"()",RD:"()"};if(!s||!Array.isArray(s.X)||s.X.length===0){s={Type:"Measure"},s.X=[i],s.D=[{...i,C:1}],s.A=[{...i,U:`(sq ${n.X?.[0].U})`,C:1}],s.R=n.R,r.put("Measure",s);return}typeof n.X?.[0].C=="number"&&s.X[0].C!==n.X[0].C&&(s.X[0].C=n.X[0].C),typeof n.X?.[0].U=="string"&&s.X[0].U!==n.X[0].U&&(s.X[0].U=n.X[0].U,s.D=[{...i,C:1}],s.A=[{...i,U:`sq ${i.U}`,C:1}],s.R=n.R),r.put("Measure",s)}applyAligment(t,e){let n=t.getObject();typeof e.Q=="number"&&n.put("Q",e.Q)}},q=class{widgetOidToKids;constructor(t){this.widgetOidToKids=t}applyAcroField(t,e){let n=t.get("Ff");typeof e.Ff=="number"&&(!n.isNumber()||n.asNumber()!==e.Ff)&&t.put("Ff",e.Ff);let r=t.get("V");e.V!==null&&e.V!==void 0&&(!r.isString()||r.asString()!==e.V)&&this.widgetOidToKids.has(e.oid)&&this.widgetOidToKids.get(e.oid)?.forEach(i=>this.applyWidget(i,t,e));let s=t.get("T");typeof e.T=="string"&&(!s.isString()||s.asString()!==e.T)&&t.put("T",`(${e.T})`)}applyWidget(t,e,n){let r=t.getObject();switch(n.FT){case"Rb":case"Cb":let s=r.get("AP","N");if(s.isIndirect()||!s.isDictionary())return;let i=Object.keys(s.asJS()),u=i.findIndex(c=>c===String(n.V));t.setChoiceValue(u>-1?i[u]:"Off"),t.update();return;case"Tx":if(typeof n.V!="string"){console.warn("The value set in the TextField is not of type string.");return}t.setTextValue(n.V),t.update();return;case"Cx":case"Lx":let a=e.get("Opt").asJS();if(!Array.isArray(a)||!a.every(Array.isArray))return;let g=a.find(c=>c[0]===String(n.V));if(!g||g.length<2)return;t.setChoiceValue(g[1]),t.update();return}}};onmessage=async o=>{let[t,e,n]=o.data;try{if(!M&&t!==Z.SET_BASE_URI)throw new Error("set base uri first");let r=await at[t](...n);postMessage(["RESULT",e,r])}catch(r){if(!(r instanceof Error)){console.error(r),postMessage(["ERROR",e,{}]);return}postMessage(["ERROR",e,r])}};var D=new Map,T=null,Y="",U=new Map,j=new Map,G=!1,J=null,w=null;function v(o){let[t,e,n,r,s,i]=o.getTransform(),u=Math.atan2(e,t)*(180/Math.PI);return u<0&&(u=360+u),u}function tt(o,t){let[e,n,r,s]=o.getBounds(),i=t*Math.PI/180,u=Math.cos(i),a=Math.sin(i),g=Math.abs(e*u+n*a),c=Math.abs(-e*a+n*u),p=Math.abs(r*u+s*a),f=Math.abs(-r*a+s*u),l=p-g,y=f-c;return{originalUpperLeftX:g,originalUpperLeftY:c,originalLowerRightX:p,originalLowerRightY:f,width:l,height:y}}function R(o,t){let e=Math.pow(10,t??5);return Math.round(o*e)/e}function W(o,t){return(o&1<<t-1)!==0}function pt(o){return o.isPDF()}function B(o){return`#${o.slice(0,3).map(e=>Math.round(e*255).toString(16).padStart(2,"0")).join("").toUpperCase()}`}function et(o,t,e){let n=t.get("Type").asName();if(n==="Page")o.set(t.asIndirect(),e.i),e.i++;else if(n==="Pages"){let r=t.get("Kids");r.isArray()?r.forEach(s=>et(o,s,e)):console.debug(`expected array (oid[${r.asIndirect()}])`)}else console.debug(`expected page tree or page object, not ${n} (oid[${t.asIndirect()}])`)}function st(o,t){let e=t.get("Names"),n=t.get("Kids");e.isArray()?e.forEach((r,s)=>{typeof s!="number"||s%2===1||!r.isString()||o.set(r.asString(),e.get(s+1))}):n.isArray()?n.forEach(r=>st(o,r)):console.debug(`expected name tree (oid[${t.asIndirect()}])`)}function H(o){let e=o.getObject().get("Rotate").valueOf()??0,n=M.Matrix.identity;n=M.Matrix.concat(n,M.Matrix.scale(4,4)),e!==0&&(n=M.Matrix.concat(n,M.Matrix.rotate(-e)));let s=o.toPixmap(n,M.ColorSpace.DeviceRGB,!0).asPNG();if(s===null)return null;let i=32768,u=[];for(let a=0;a<s.byteLength;a+=i)u.push(String.fromCharCode(...Array.from(s.subarray(a,a+i))));return{data:btoa(u.join("")),format:"png",type:"image"}}function $(o,t){let e=t.get("DA")?.asString()?.match(h.defaultAppearanceFontNameRegex)?.[1];return{strokeColor:B(o.color),fontName:e??o.font,fontSize:o.size}}function nt(o,t,e,n){let r=o.getObject(),s={},[i,u,a,g]=(o.hasRect()?o.getRect():o.getBounds()).map(R);s.rect=k.deviceRectToUser({left:i,top:u,right:a,bottom:g},n,t,e);let c=o.getOpacity();c!==null&&(s.opacity=c),s.Rotate=r.get("Rotate").asNumber()??0;let p=r.get("CreationDate");p.isString()&&(s.CreationDate=p.asString());let f=r.get("M");f.isString()&&(s.M=f.asString());let l=o.getContents();l?.length>0&&(s.contents=l);let y=o.getFlags();if(y!==null&&(s.F=y),!r.get("AP").isNull()){let m=H(o);m!==null&&(s.appearance=m)}if(o.hasAuthor()){let m=o.getAuthor();m?.length>0&&(s.T=m)}let d=r.get("NM");if(d.isString()&&(s.NM=d.asString()),o.hasBorder()){let m=o.getBorderWidth();m!==null&&(s.width=m),s.borderStyle={style:"solid"};let x=o.getBorderStyle();x!==null&&(s.borderStyle.style=x.toLowerCase(),x==="Dashed"&&(s.borderStyle.dashPattern=o.getBorderDashPattern())),o.hasBorderEffect()&&o.getBorderEffect()==="Cloudy"&&(s.borderEffect={style:"C",intensity:o.getBorderEffectIntensity()})}else{let m=r.get("BS","W");m.isNumber()?s.width=m.asNumber():o.getType()==="Redact"&&(s.width=2)}let F=r.get("C");r.get("C").isArray()&&(s.color=B(F.asJS()));let b=r.get("IC");if(r.get("IC").isArray()&&(s.InteriorColor=B(b.asJS())),o.getType()==="Redact"){let m=r.get("OC");if(r.get("OC").isArray()&&(s.OutlineColor=B(m.asJS())),r.get("DA").isString()){let{fontName:C,fontSize:L,strokeColor:N}=$(o.getDefaultAppearance(),r);s.fontName=C,s.fontSize=L,s.fontColor=N}let x=r.get("Q");if(x.isNumber())switch(x.asNumber()){case 0:s.alignment="left";break;case 1:s.alignment="center";break;case 2:s.alignment="right"}let S=r.get("OverlayText");S.isString()&&(s.overlayText=S.asString())}if(o.getType()==="FreeText"){let m=$(o.getDefaultAppearance(),r);s.contentsRichtext={text:o.getContents()??"",borderColor:m.strokeColor,fontName:m.fontName,fontSize:m.fontSize},r.get("DS").asString()?.split(";").forEach(N=>{let[I,E]=N.split(":").map(A=>A.trim());switch(I){case"color":s.contentsRichtext.fontColor=E?.toUpperCase();break;case"text-align":s.contentsRichtext.textAlign=E}});let S=o.getCalloutLine();S!==null&&(s.vertices=S.map(N=>{let[I,E]=N;return k.deviceToUser({x:I,y:E},n,t,e)}));let C=r.get("LE");C.isName()&&(s.LE=[C.asName()]);let L=r.get("RD");if(L.isArray()&&L.asJS()?.some(N=>N!==0)){s.textRect={left:s.rect.left,top:s.rect.top,right:s.rect.right,bottom:s.rect.bottom};let[N,I,E,A]=o.getBounds().map(R);s.rect=k.deviceRectToUser({left:N,top:I,right:E,bottom:A},n,t,e)}}if(o.hasQuadPoints()){let m=o.getQuadPoints();m.length>0&&(s.quadPoints=m.map(x=>x.reduce((S,C,L)=>(L%2===0&&S.push(k.deviceToUser({x:x[L],y:x[L+1]},n,t,e)),S),[])))}if(o.hasLine()){let[[m,x],[S,C]]=o.getLine();if(s.coordinates={sp:k.deviceToUser({x:m,y:x},n,t,e),ep:k.deviceToUser({x:S,y:C},n,t,e)},o.hasLineEndingStyles()){let{start:I,end:E}=o.getLineEndingStyles();s.LE=[I,E]}r.get("LL").isNumber()&&(s.LL=o.getLineLeader()),r.get("LLE").isNumber()&&(s.LLE=o.getLineLeaderExtension())}let P=r.get("Measure");return P.isDictionary()&&(s.Measure={R:P.get("R").asString()},s.Measure.X=[],P.get("X").forEach(m=>{s.Measure.X.push({C:R(m.get("C").asNumber(),6),D:m.get("D").asNumber(),U:m.get("U").asString()})})),o.hasInkList()&&(s.inkList=o.getInkList().map(m=>m.map(([x,S])=>k.deviceToUser({x:R(x),y:R(S)},n,t,e)))),o.hasVertices()&&(s.vertices=o.getVertices().map(([m,x])=>k.deviceToUser({x:R(m),y:R(x)},n,t,e))),s}function lt(o){let t={},e=o.get("CA");e.isNumber()&&(t.opacity=e.asNumber()),t.Rotate=o.get("Rotate").asNumber()??0;let n=o.get("CreationDate");n.isString()&&(t.CreationDate=n.asString());let r=o.get("M");r.isString()&&(t.M=r.asString());let s=o.get("F");s.isNumber()&&(t.F=s.asNumber());let i=o.get("NM");return i.isString()&&(t.NM=i.asString()),t}function gt(o){let t={},e=o.get("Rect");if(e.isArray()){let[l,y,d,F]=e.asJS();t.rect={left:R(l),top:R(F),right:R(d),bottom:R(y)}}let n=o.get("CA");n.isNumber()&&(t.opacity=n.asNumber()),t.Rotate=o.get("Rotate").asNumber()??0;let r=o.get("CreationDate");r.isString()&&(t.CreationDate=r.asString());let s=o.get("M");s.isString()&&(t.M=s.asString());let i=o.get("Contents");if(i.isString()){let l=i.asString();l.length>0&&(t.contents=l)}let u=o.get("F");u.isNumber()&&(t.F=u.asNumber());let a=o.get("NM");a.isString()&&(t.NM=a.asString());let g=o.get("BS","S");if(g.isName())switch(g.asName()){case"D":t.borderStyle={style:"dashed"};let l=o.get("BS","D");t.borderStyle.dashPattern=l.isArray()?l.asJS():[3];break;case"S":default:t.borderStyle={style:"solid"}}let c=o.get("BS","W");c.isNumber()&&(t.width=c.asNumber());let p=o.get("C");p.isArray()&&(t.color=B(p.asJS()));let f=it(o);return Object.keys(f).filter(l=>["dest","fit","type"].includes(l)).forEach(l=>t[l]=f[l]),t}function ft(o,t,e,n){let r=nt(o,t,e,n),s=o.getObject(),i=s.get("FT");i.isName()&&(r.FT=i.asName()),r.Ff=o.getFieldFlags()??0;let u=s.get("T");if(u.isString()&&(r.T=u.asString()),o.isText()||o.isPushButton()||o.isChoice()){let{fontName:l,fontSize:y,strokeColor:d}=$(o.getDefaultAppearance(),s);r.fontName=l,r.fontSize=y,r.fontColor=d}let a=s.get("MK");if(a.isDictionary()){let l=a.get("R");r.MK={R:l.isNumber()?l.asNumber():0};let y=a.get("BG");y.isArray()&&(r.MK.backgroundColor=B(y.asJS()));let d=a.get("BC");d.isArray()&&(r.MK.borderColor=B(d.asJS()));let F=a.get("CA");F.isString()&&(r.MK.CA=F.asString())}let g=s.get("Q");if(g.isNumber())switch(g.asNumber()){case 0:r.alignment="left";break;case 1:r.alignment="center";break;case 2:r.alignment="right"}let c=s.get("Parent");if(c.isIndirect()&&(r.Parent=c.asIndirect(),c.get("FT").asName()==="Btn")){let l=c.get("V");l.isNull()||(r.V=l.valueOf())}let p=s.get("AP","N");if(!p.isIndirect()&&p.isDictionary()){r.AP_N=Object.keys(p.asJS());let l=o.getValue();r.appearance=[{state:l,data:r.appearance.data,format:"png",type:"image"},...r.AP_N.filter(y=>y!==l).reduce((y,d)=>(o.setTextValue(d),y.push({state:d,...H(o)}),o.setTextValue(l),y),[])]}let f=s.get("A","S");if(f.isName()&&(r.type=f.asName(),r.type==="JavaScript")){let l=s.get("A","JS");l.isString()&&(r.JS=l.asString())}return r}function rt(o){if(!T||!D.get(T))throw new Error("no opened document");j.has(o)||st(j,D.get(T).document.getTrailer().get("Root","Names","Dests"));let t=j.get(o);return t===void 0?null:ot(t.get("D").isArray()?t.get("D"):t)}function ot(o){if(o.isArray()){let[t,e,...n]=o.asJS(),r=o.get(0).asIndirect();if(!U.has(r)){if(!T||!D.get(T))throw new Error("no opened document");et(U,D.get(T).document.getTrailer().get("Root","Pages"),{i:0})}let s=U.get(r);if(s===void 0||s<0)return null;let i={};switch(e){case"XYZ":i.left=n[0],i.top=n[1],i.zoom=n[2];break;case"FitH":case"FitBH":i.top=n[0];break;case"FitV":case"FitBV":i.left=n[0];break;case"FitR":i.left=n[0],i.bottom=n[1],i.right=n[2],i.top=n[3];break;case"Fit":case"FitB":default:i=null;break}return{pageIndex:s,mode:e,coordinates:i}}else return o.isString()?rt(o.asString()):(console.debug("unsupported destination type",o.asIndirect()),null)}function it(o){let t=o.get("A"),e=o.get("Dest"),n={};if(t.isNull())if(e.isString()){let r=rt(e.asString());r&&(n.type="GoTo",n.dest=r.pageIndex,n.fit=r.coordinates===null?{mode:r.mode}:{mode:r.mode,args:r.coordinates})}else e.isNull()?console.debug("no action or destination",o.asIndirect()):console.debug("unsupported destination type",e.asIndirect(),e.valueOf());else{let r=o.get("A","S");switch(r.isName()&&(n.type=r.asName()),n.type){case"GoTo":let s=ot(t.get("D"));n.dest=s.pageIndex,n.fit=s.coordinates===null?{mode:s.mode}:{mode:s.mode,args:s.coordinates};break;case"URI":let i=o.get("A","URI");i.isString()&&(n.dest=i.asString());break;default:console.debug("unsupported action type",t.asIndirect(),n.type)}}return n}var at={setBaseURI:async o=>{Y=`${o}modules/mupdf/`,M=await import(`${Y}mupdf.js`)},openDocument:(o,t,e)=>{let n=M.Document.openDocument(o,t);if(!pt(n))throw new Error("doc is not pdf");w=new K,M.installLoadFontFunction((r,s,i,u)=>["JP","KR","TC","SC"].includes(s)?J?new M.Font("fallback",J):(G=!0,null):null),D.size===0&&(T=e),D.set(e,{document:n,filename:t,size:o.byteLength}),U.clear(),j.clear()},closeDocument:o=>{let t=o&&o.length>0?o:T;if(t===null||D.get(t)===void 0)throw new O("No opened document.");D.get(t).document.destroy(),D.delete(t)},downloadDocument:o=>{let t=o&&o.length>0?o:T;if(t===null||D.get(t)===void 0)throw new O("No opened document.");return D.get(t).document.saveToBuffer().asUint8Array()},drawPageAsPNG:async(o,t,e,n)=>{let r=M.Matrix.identity,s,i,u,a;try{let g=M.Matrix.scale(t,t);r=M.Matrix.concat(r,g);let c=M.Matrix.rotate(e);r=M.Matrix.concat(r,c);let p=n&&n.length>0?n:T;if(p===null||D.get(p)===void 0)throw new O("No opened document.");if(s=D.get(p).document.loadPage(o),u=M.Rect.transform(s.getBounds(),r),i=new M.Pixmap(M.ColorSpace.DeviceRGB,u,!1),i.clear(255),a=new M.DrawDevice(r,i),G=!1,s.runPageContents(a,M.Matrix.identity),G){try{J=await w?.buffer??null}catch(f){console.error(f),M.installLoadFontFunction(()=>null),postMessage(["TOAST",null,{action:"SHOW",toastOption:{toastStyle:"notification",content:"TEXT_RENDER_WARNING",header:"UNAVAILABLE_FONT"}}])}i.clear(255),s.runPageContents(a,M.Matrix.identity)}return a.close(),a.destroy(),i?.asPNG()}finally{i?.destroy(),s?.destroy()}},loadOutline:o=>{let t=o&&o.length>0?o:T;if(t===null||D.get(t)===void 0)throw new O("No opened document.");let e=D.get(t).document,n=r=>{let s=r,i=[];for(;!s.isNull();){let u={},a=s.get("Title"),g=s.get("First");g.isNull()||(u.children=n(g)),a.isString()&&(u.text=a.asString());let c=it(s);Object.keys(c).filter(p=>["dest","fit"].includes(p)).forEach(p=>u[p]=c[p]),i.push(u),s=s.get("Next")}return i};return n(e.getTrailer().get("Root","Outlines","First"))},loadPdfInfo:o=>{let t=o??T;if(t===null||D.get(t)===void 0)throw new O("No opened document.");let e=D.get(t),{document:n,filename:r,size:s}=e,i={},u={},a=n.getMetaData("format"),[g,c]=a.split(" "),p=new Map([["Author","info:Author"],["CreationDate","info:CreationDate"],["Creator","info:Creator"],["Keywords","info:Keywords"],["ModDate","info:ModDate"],["Producer","info:Producer"],["Subject","info:Subject"],["Title","info:Title"]]),f=new Map([["Printing","print"],["HighQualityPrinting","print-hq"],["ModifyingContents","edit"],["Commenting","annotate"],["FillingForms","form"],["DocumentAssembly","assemble"],["Accessibility","accessibility"],["CopyingContents","copy"]]);p.forEach((d,F)=>i[F]=n.getMetaData(d)),f.forEach((d,F)=>u[F]=n.hasPermission(d));let l={Direction:"L2R"},y=n.getTrailer().get("Root","Root","ViewerPreferences","Direction");return y.isName()&&(l.Direction=y.asName()),{...i,ViewerPreferences:l,PageCount:n.countPages(),Version:c,Security:u,FileName:r,FileSize:s}},loadPageText:(o,t)=>{let e=t??T;if(e===null||D.get(e)===void 0)throw new O("No opened document.");let n=D.get(e).document.loadPage(o),r=n.toStructuredText(["preserve-ligatures","preserve-whitespace","preserve-spans","preserve-images"].join(",")),s=v(n),{width:i,height:u,originalLowerRightY:a}=tt(n,s),g=(d,F)=>{let b=[];for(let P=0;P<d.length;P+=2){let m=d[P],x=d[P+1],S,C;F===90?(S=x,C=u-m):F===180?(S=i-m,C=u-x):F===270?(S=i-x,C=m):(S=m,C=x),b.push(S,C)}return b},c=[],p={text:""},f=[],l,y=()=>{let d=/^\s*$/,F=d.test(p.text)?[]:[...f],b=d.test(p.text)?"":p.text;c.push({...p,rect:F,text:b})};return r.walk({beginLine:(d,F,b)=>{p.isVertical=F===1;let P=Math.atan2(b[1],b[0])*180/Math.PI;P<0&&(P=360+P);let m=Math.abs(s-P);p.rotate=s===P?0:m},onChar:(d,F,b,P,m)=>{let x=[...m],[S,C,L,N,I,E,A,z]=g(x,s),_={left:Math.floor(Math.min(S,L,I,A)),bottom:Math.floor(a-Math.max(C,N,E,z)),right:Math.floor(Math.max(S,L,I,A)),top:Math.floor(a-Math.min(C,N,E,z))};_.bottom===_.top&&(_.top=_.bottom+P),Math.abs(l-_.bottom)>P&&(y(),p.text="",f.length=0),p.text=`${p.text}${d.charCodeAt(0)===65533?" ":d}`,f.push(_),l=_.bottom}}),y(),c},loadPdfLayout:o=>{let t=o??T;if(!t)throw new Error("No opened document.");let e=D.get(t)?.document;if(!e)throw new Error("No opened document.");let n=D.get(t).document.countPages(),r=[];for(let s=0;s<n;s++){let i=e.loadPage(s),u=v(i),{width:a,height:g,originalUpperLeftX:c,originalUpperLeftY:p}=tt(i,u),f=i.getObject().get("Annots"),l=f.isArray()?f.length>0:!!(i.getAnnotations().length||i.getWidgets().length||i.getLinks().length);r.push({bbox:{x:R(c,2),y:R(p,2),w:R(a,2),h:R(g,2)},i:s,r:u,originalR:u,annot:l,originalIndex:s,ref:s})}return r},authenticatePassword:(o,t)=>{let e=t??T;if(e===null||D.get(e)===void 0)throw new O("No opened document.");return D.get(e).document.authenticatePassword(o??"")},getPrintBlobURL:(o,t,e,n)=>{let r,s;try{let i=n&&n.length>0?n:T;if(i===null||D.get(i)===void 0)throw new O("No opened document.");r=D.get(i).document.loadPage(o);let[u,a,g,c]=r.getBounds(),p=Math.abs(g-u),l=p/72*e,y=Math.round(l/p);s=r.toPixmap(M.Matrix.scale(y,y),M.ColorSpace.DeviceRGB,!1,t,"Print");let d=new Blob([s.asPNG()],{type:"image/png"});return URL.createObjectURL(d)}catch(i){throw i}finally{r?.destroy(),s?.destroy()}},getAnnotations:(o,t)=>{let e=t&&t.length>0?t:T;if(e===null||D.get(e)===void 0)throw new O("No opened document.");let r=D.get(e).document.loadPage(o),[s,i,u,a]=r.getBounds(),g=u-s,c=a-i,p=r.getObject().get("Rotate").asNumber()??0,f=r.getAnnotations(),l=r.getWidgets(),y=r.getObject().get("Annots"),d=[];y.isArray()&&y.forEach(b=>{b.get("Subtype").asName()==="Link"&&d.push(b)});let F=[];return F.push(...f.map(b=>{try{let P=b.getObject(),m={attributes:{pageIdx:o,...nt(b,g,c,p)},oid:P.asIndirect(),type:b.getType(),visible:!0},x=P.get("IT");x.isName()&&(m.IT=x.asName());let S=P.get("Popup");if(S.isIndirect()){m.Popup=S.asIndirect();let[L,N,I,E]=b.getPopup();F.push({attributes:{...lt(S),pageIdx:o,rect:{left:R(L),top:R(c-N),right:R(I),bottom:R(c-E)}},oid:m.Popup,type:S.get("Subtype").asName()??"Popup",visible:!0})}let C=P.get("IRT");return C.isIndirect()&&(m.IRT=C.asIndirect()),m}catch(P){return console.error(P),null}}).concat(d.map(b=>{try{return{attributes:{pageIdx:o,...gt(b)},oid:b.asIndirect(),type:b.get("Subtype").asName()??"Link",visible:!0}}catch(P){return console.error(P),null}})).concat(l.map(b=>{try{return{attributes:{pageIdx:o,...ft(b,g,c,p)},oid:b.getObject().asIndirect(),type:b.getType()??"Widget",visible:!0}}catch(P){return console.error(P),null}})).filter(b=>b!==null)),F},getAcroForm:o=>{let t=o&&o.length>0?o:T;if(t===null||D.get(t)===void 0)throw new O("No opened document.");let e=D.get(t).document.getTrailer().get("Root","AcroForm");if(e.isNull())return{fields:{},props:{CO:[]}};let n=e.get("Fields"),r={};n.forEach(u=>{let a={};a.oid=u.asIndirect();let g=u.get("FT");g.isName()&&(a.FT=g.asName());let c=u.get("Ff");c.isNumber()&&(a.Ff=c.asNumber(),a.FT==="Btn"?W(a.Ff,16)?a.FT="Rb":W(a.Ff,17)||(a.FT="Cb"):a.FT==="Ch"&&(W(a.Ff,18)?a.FT="Cx":a.FT="Lx"));let p=u.get("T");p.isString()&&(a.T=p.asString());let f=u.get("V");f.isNull()||(a.V=f.asJS());let l=u.get("AA");l.isDictionary()&&(a.AA=l.asJS());let y=u.get("Kids");y.isArray()&&(a.Kids=[],y.forEach((b,P)=>{a.Kids.push({i:P,oid:b.asIndirect()})}));let d=u.get("I");d.isArray()&&(a.I=d.asJS());let F=u.get("Opt");F.isArray()&&(a.Opt=F.asJS()),r[a.oid]=a});let s=[],i=e.get("CO");return i.isArray()&&i.forEach(u=>{s.push({oid:u.asIndirect()})}),{fields:r,props:{CO:s}}},applyAnnotChanges:(o,t)=>{let e=t&&t.length>0?t:T;if(e===null)throw new O("No opened document.");let n=D.get(e).document,r=new V(n);o.forEach(s=>{let i=n.loadPage(s.pageIndex);if(!i){console.error("Cannot find a page with annotations to apply the changes.");return}let u=[...i.getAnnotations(),...i.getWidgets()];s.annots.forEach(a=>{switch(a.action){case"create":let g=a.Popup,c;g!==void 0&&(c=i.createAnnotation(g.subType),r.apply(c,g),c.update());let p=i.createAnnotation(a.subType);r.apply(p,a),c!==void 0&&(p.getObject().put("Popup",c.getObject()),p.update()),a.replies?.forEach(y=>{let d=i.createAnnotation(y.subType);r.apply(d,y),d.getObject().put("IRT",p.getObject()),d.update()});return;case"modify":case"remove":let f=a.NM;if(!f){console.error("The NM field of the annotation does not exist.");return}let l=u.find(y=>{let d=y.getObject().get("NM");return d.isString()?d.asString()===f:!1});if(!l){console.error(`No annotation for NM (${f})`);return}switch(a.action){case"modify":r.apply(l,a);return;case"remove":i.deleteAnnotation(l);return}}})})},applyAcroFieldChanges:(o,t)=>{let e=t&&t.length>0?t:T;if(e===null)throw new O("No opened document.");let n=D.get(e).document,r=n.getTrailer().get("Root","AcroForm","Fields"),s=n.countPages(),i=new Map,u=new q(i);for(let a=0;a<s;a++)n.loadPage(a).getWidgets().forEach(c=>{let p=c.getObject().get("Parent");if(p.isNull())return;let f=p.asIndirect();if(i.has(f)){i.get(f)?.push(c);return}i.set(f,[c])});o.forEach(a=>{switch(a.action){case"create":case"remove":break;case"modify":let g=(()=>{let c=[];r.forEach(f=>c.push(f));let p=c.findIndex(f=>f.asIndirect()===a.oid);return p>-1?r.get(p):null})();if(g===null){console.error("AcroField could not be found.",a);return}u.applyAcroField(g,a);break}})},applyRedaction:(o,t)=>{let e=t&&t.length>0?t:T;if(e===null||D.get(e)===void 0)throw new O("No opened document.");let n=D.get(e).document,r=new V(n),s=(i,u)=>{let a=u.getObject().get("Rect");if(a.isNull())return;let g=f=>{let[l,y,d,F]=f;return{left:Math.min(l,d),top:Math.min(y,F),right:Math.max(l,d),bottom:Math.max(y,F)}},c=g(a.asJS());[...i.getAnnotations().filter(f=>f.getObject().get("Subtype").asName()!=="Redact"),...i.getWidgets()].forEach(f=>{let y=f.getObject().get("Rect");if(y.isNull())return;let d=g(y.asJS());d.right<c.left||d.left>c.right||d.top>c.bottom||d.bottom<c.top||i.deleteAnnotation(f)})};o.forEach(i=>{let u=n.loadPage(i.pageIdx),a=u.getAnnotations().filter(g=>g.getType()==="Redact");i.redactions.forEach(g=>{let c=a.find(p=>{let f=p.getObject().get("NM");return f.isString()&&f.asString()===g.NM});c||(c=u.createAnnotation("Redact"),r.apply(c,g)),s(u,c),c.applyRedaction(1,M.PDFPage.REDACT_IMAGE_PIXELS,M.PDFPage.REDACT_LINE_ART_REMOVE_IF_COVERED,M.PDFPage.REDACT_TEXT_REMOVE)})})},getStampTemplateImages:o=>{let t=o&&o.length>0?o:T;if(t===null)throw new O("No opened document.");let n=D.get(t).document.loadPage(0),r=n.createAnnotation("Stamp"),s=[];return["Approved","AsIs","Confidential","Departmental","Draft","Experimental","Expired","Final","ForComment","ForPublicRelease","NotApproved","NotForPublicRelease","Sold","TopSecret"].forEach(u=>{r.setIcon(u),r.update();let a=H(r);s.push({name:u,data:`data:${a?.type}/${a?.format};base64, ${a?.data}`})}),n.deleteAnnotation(r),s}};postMessage(["INIT",0,Object.keys(at)]);
